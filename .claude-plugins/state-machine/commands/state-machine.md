---
description: 計画ファイルにステートマシン図を追加し、要件を明確化
argument-hint: [計画ファイルのパス（省略時は自動検索）]
allowed-tools: Read, Write, Edit, Glob, Grep, AskUserQuestion
context: fork
---

計画ファイルを読み、ステートマシン図（ASCII形式）を生成して要件を明確化する。

<goals>
- 状態遷移図でレビューしやすくし、認識齟齬を減らす
- 状態遷移として整理し、処理の抜け漏れを発見して埋める
- 曖昧な点はAskUserQuestionで質問し、確定した内容のみを計画ファイルに反映する
</goals>

## Phase 1: 計画ファイルの特定

`$ARGUMENTS`が指定されている場合はそのファイルを使用。

未指定の場合は以下を順に検索：
1. `**/PLAN.md`, `**/plan.md`
2. `**/SPEC.md`, `**/spec.md`
3. `**/docs/*.md`のうち計画・仕様に関するもの

見つからない場合 → ユーザーに確認

## Phase 2: 状態と遷移の抽出

計画ファイルから以下を特定：

| 要素 | 説明 |
|------|------|
| 状態 | システムが取りうる各状態 |
| 遷移 | 状態間の移動とトリガー |
| 初期状態 | 処理の開始点 |
| 終了状態 | 処理の完了点（複数可） |

## Phase 3: 網羅性チェックと曖昧さの解消

以下の観点で抜け漏れを検出：

- 各状態から出る遷移が定義されているか
- エラー時、キャンセル時、タイムアウト時の遷移
- すべてのフローが終了状態に到達できるか
- どこからも遷移できない孤立状態がないか

抜け漏れや曖昧な点を発見した場合、AskUserQuestionツールで質問する。

<constraints>
- 2〜4個の質問（曖昧さのレベルに応じて調整）
- 各質問に2〜4個の具体的な選択肢
- 各選択肢にメリット・デメリットを含める
- オープンエンドな質問は避ける（「その他」は自動付与）
</constraints>

回答を反映してPhase 2-3を繰り返す。すべての状態遷移が確定するまで続ける。

## Phase 4: ASCII図の生成と計画ファイルの更新

確定した状態遷移からASCII図を生成し、計画ファイルに追加する。

````markdown
## State Machine

```
┌─────────┐    submit     ┌───────────┐    approve    ┌──────────┐
│  Draft  │ ────────────► │  Review   │ ─────────────► │ Approved │
└─────────┘               └───────────┘               └──────────┘
     │                          │
     │ cancel                   │ reject
     ▼                          ▼
┌─────────┐               ┌───────────┐
│ Deleted │               │  Draft    │
└─────────┘               └───────────┘
```
````

最後に変更内容のサマリーを提示。

---

対象: $ARGUMENTS
